{% load crispy_forms_tags %}
{% load static %}
<div class="container-fluid py-4 w-100">
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-danger text-white">
            <h3 class="card-title h3 mb-0 text-center">Consumo de Inventario / {{ inventario_name }}</h3>
        </div>
        <div class="card-body">
            <form method="POST" action="">
                {% csrf_token %}
                {% if lotes %}
                    <div class="table-responsive">
                        <table class="table table-hover rounded">
                            <thead>
                                <tr>
                                    <th>Marcar Todos: <input type="checkbox" id="selectAll"></th>
                                    <th>Insumo</th>
                                    <th>Cantidad Disponible</th>
                                    <th>Fecha de Vencimiento</th>
                                    <th>Cantidad a Consumir</th>
                                    <th>Descripción</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for lote in lotes %}
                                    <tr>
                                        <td>
                                            <input type="checkbox" name="consumir_lote_{{ lote.id }}" id="consumir_lote_{{ lote.id }}" class="item-checkbox">
                                        </td>
                                        <td>{{ lote.insumo.nombre }} ({{ lote.insumo.presentacion }})</td>
                                        <td>{{ lote.cantidad }}</td>
                                        <td>{{ lote.fecha_vencimiento|date:"d/m/Y" }}</td>
                                        <td>
                                            <input type="number" name="cantidad_{{ lote.id }}" class="form-control" min="1" max="{{ lote.cantidad }}" disabled>
                                        </td>
                                        <td>
                                            <textarea name="descripcion_{{ lote.id }}" class="form-control" rows="1" disabled></textarea>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div class="d-flex justify-content-center mt-3">
                        <button type="submit" class="btn btn-danger">Registrar Consumo(s)</button>
                    </div>
                {% else %}
                    <p class="alert alert-info">Este inventario no tiene insumos disponibles para consumir.</p>
                {% endif %}
            </form>
        </div>
    </div>
</div>
<script>
    // Script para manejar la lógica de la tabla de consumo
    document.addEventListener('DOMContentLoaded', function () {
        const selectAllCheckbox = document.getElementById('selectAll');
        const itemCheckboxes = document.querySelectorAll('.item-checkbox');

        // Función para habilitar/deshabilitar campos
        function toggleFields(checkbox) {
            const row = checkbox.closest('tr');
            const cantidadInput = row.querySelector('[name^="cantidad_"]');
            const descripcionInput = row.querySelector('[name^="descripcion_"]');

            if (checkbox.checked) {
                cantidadInput.removeAttribute('disabled');
                descripcionInput.removeAttribute('disabled');
                cantidadInput.setAttribute('required', 'true');
            } else {
                cantidadInput.setAttribute('disabled', 'true');
                descripcionInput.setAttribute('disabled', 'true');
                cantidadInput.removeAttribute('required');
                cantidadInput.value = '';
                descripcionInput.value = '';
            }
        }

        // Evento para el checkbox 'Seleccionar todos'
        selectAllCheckbox.addEventListener('change', function() {
            itemCheckboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
                toggleFields(checkbox);
            });
        });

        // Evento para cada checkbox de item
        itemCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                toggleFields(this);
                // Si algún checkbox está desmarcado, desmarca el 'Seleccionar todos'
                if (!this.checked) {
                    selectAllCheckbox.checked = false;
                }
            });
        });
    });
</script>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="{% static 'js/insumos_medicos/obtener_insumos.js' %}"></script>