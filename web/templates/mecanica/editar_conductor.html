{% if user.user == "SeRvEr" %}
{% include "layouts/panel_admin.html" %}
{% elif user.user == "Sala_Situacional" %}
{% include "layouts/panel_sala_situacional.html" %}
{% elif user.user == "Comandancia" or user.user == "2dacomandancia" %}
{% include "layouts/panel_comandancia.html" %}
{% elif user.user == "Mecanica_01"%}
{% include "layouts/panel_mecanica.html" %}
{% endif %}

{% load static %}

{% block content %}
<div class="general-dashboard">
  <div class="div-user-name username-space">
    <h3 class="division-title">Editar Conductor</h3>
    <section class="user-name">
      <p>{{ jerarquia }} {{ nombres }} {{ apellidos }} / <span id="usuario">{{ user.user }}</span></p>
      <svg width="30px" height="30px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
        <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
        <g id="SVGRepo_iconCarrier">
          <path fill-rule="evenodd" clip-rule="evenodd"
            d="M12.0001 1.25C9.37678 1.25 7.25013 3.37665 7.25013 6C7.25013 8.62335 9.37678 10.75 12.0001 10.75C14.6235 10.75 16.7501 8.62335 16.7501 6C16.7501 3.37665 14.6235 1.25 12.0001 1.25ZM8.75013 6C8.75013 4.20507 10.2052 2.75 12.0001 2.75C13.7951 2.75 15.2501 4.20507 15.2501 6C15.2501 7.79493 13.7951 9.25 12.0001 9.25C10.2052 9.25 8.75013 7.79493 8.75013 6Z"
            fill="#000000"></path>
          <path fill-rule="evenodd" clip-rule="evenodd"
            d="M12.0001 12.25C9.68658 12.25 7.55506 12.7759 5.97558 13.6643C4.41962 14.5396 3.25013 15.8661 3.25013 17.5L3.25007 17.602C3.24894 18.7638 3.24752 20.222 4.52655 21.2635C5.15602 21.7761 6.03661 22.1406 7.22634 22.3815C8.4194 22.6229 9.97436 22.75 12.0001 22.75C14.0259 22.75 15.5809 22.6229 16.7739 22.3815C17.9637 22.1406 18.8443 21.7761 19.4737 21.2635C20.7527 20.222 20.7513 18.7638 20.7502 17.602L20.7501 17.5C20.7501 15.8661 19.5807 14.5396 18.0247 13.6643C16.4452 12.7759 14.3137 12.25 12.0001 12.25ZM4.75013 17.5C4.75013 16.6487 5.37151 15.7251 6.71098 14.9717C8.02693 14.2315 9.89541 13.75 12.0001 13.75C14.1049 13.75 15.9733 14.2315 17.2893 14.9717C18.6288 15.7251 19.2501 16.6487 19.2501 17.5C19.2501 18.8078 19.2098 19.544 18.5265 20.1004C18.156 20.4022 17.5366 20.6967 16.4763 20.9113C15.4194 21.1252 13.9744 21.25 12.0001 21.25C10.0259 21.25 8.58087 21.1252 7.52393 20.9113C6.46366 20.6967 5.84425 20.4022 5.47372 20.1004C4.79045 19.544 4.75013 18.8078 4.75013 17.5Z"
            fill="#000000"></path>
        </g>
      </svg>
    </section>
  </div>
</div>

<br>

<div class="container-fluid">

  <form method="post" enctype="multipart/form-data" class="needs-validation" novalidate>
    {% csrf_token %}

    <input type="hidden" value="{{conductor.id}}"> 

    <!-- Sección Datos Personales -->
    <div class="card mb-4 shadow-sm">
      <div class="card-header bg-primary text-white">
        <h4 class="mb-0"><i class="fas fa-id-card mr-2"></i>Datos Personales</h4>
      </div>
      <div class="card-body">
        <div class="row">
          <!-- Columna Izquierda -->
          <div class="col-md-6">
            <div class="form-group">
              <label for="{{ form.personal.id_for_label }}" class="font-weight-bold">Personal:</label>
              {{ form.personal }}
              <small class="form-text text-muted">Seleccione el miembro del personal</small>
            </div>
          </div>
          
          <!-- Columna Derecha -->
          <div class="col-md-6">
            <div class="form-row">
              <div class="form-group">
                <label for="{{ form.fecha_ingreso.id_for_label }}" class="font-weight-bold">Fecha Vencimiento (Cedula):</label>
                {{ form.fecha_vencimiento }}
              </div>
            </div>
      
          </div>
        </div>
        
      </div>
    </div>
    
    <!-- Sección Licencias -->
    <div class="card mb-4 shadow-sm">
      <div class="card-header bg-primary text-white">
        <h4 class="mb-0"><i class="fas fa-id-card-alt mr-2"></i>Licencias de Conducir</h4>
      </div>
      <div class="card-body">
        {{ licencia_formset.management_form }}
        <div id="licencias-container">
          {% for form in licencia_formset %}
          <div class="licencia-form card mb-3">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
              <h5 class="mb-0">Licencia #{{ forloop.counter }}</h5>
              {% if form.instance.pk %}
              <div class="custom-control custom-checkbox">
                {{ form.DELETE }}
                <label for="{{ form.DELETE.id_for_label }}" class="custom-control-label text-danger">Eliminar</label>
              </div>
              {% endif %}
              {% if form.instance.pk %}
                <input type="hidden" name="{{ form.prefix }}-id" value="{{ form.instance.id }}">
              {% endif %}
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6">
                  <div class="form-group">
                    <label for="{{ form.tipo_licencia.id_for_label }}" class="font-weight-bold">Tipo:</label>
                    {{ form.tipo_licencia }}
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-group">
                    <label for="{{ form.numero_licencia.id_for_label }}" class="font-weight-bold">Número:</label>
                    {{ form.numero_licencia }}
                  </div>
                </div>
              </div>
              
              <div class="row">
                <div class="col-md-4">
                  <div class="form-group">
                    <label for="{{ form.fecha_emision.id_for_label }}" class="font-weight-bold">Fecha Emisión:</label>
                    {{ form.fecha_emision }}
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="form-group">
                    <label for="{{ form.fecha_vencimiento.id_for_label }}" class="font-weight-bold">Fecha Vencimiento:</label>
                    {{ form.fecha_vencimiento }}
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="form-group">
                    <label for="{{ form.organismo_emisor.id_for_label }}" class="font-weight-bold">Organismo Emisor:</label>
                    {{ form.organismo_emisor }}
                  </div>
                </div>
              </div>
              
              <div class="row">
                <div class="col-md-6">
                  <div class="form-group">
                    <label for="{{ form.restricciones.id_for_label }}" class="font-weight-bold">Restricciones:</label>
                    {{ form.restricciones }}
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-group">
                    <label for="{{ form.observaciones.id_for_label }}" class="font-weight-bold">Observaciones:</label>
                    {{ form.observaciones }}
                  </div>
                </div>
              </div>
              
            </div>
          </div>
          {% endfor %}
        </div>
        
        <button type="button" class="btn btn-outline-primary mt-2" id="add-licencia">
          <i class="fas fa-plus-circle mr-2"></i>Agregar otra licencia
        </button>
      </div>
    </div>
    
    <!-- Sección Certificados Médicos -->
    <div class="card mb-4 shadow-sm">
      <div class="card-header bg-primary text-white">
        <h4 class="mb-0"><i class="fas fa-file-medical mr-2"></i>Certificados Médicos</h4>
      </div>
      <div class="card-body">
        {{ certificado_formset.management_form }}
        <div id="certificados-container">
          {% for form in certificado_formset %}
          <div class="certificado-form card mb-3">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
              <h5 class="mb-0">Certificado #{{ forloop.counter }}</h5>
              {% if form.instance.pk %}
                <div class="custom-control custom-checkbox">
                  {{ form.DELETE }}
                  <label for="{{ form.DELETE.id_for_label }}" class="custom-control-label text-danger">Eliminar</label>
                </div>
              {% endif %}

              {% if form.instance.pk %}
                <input type="hidden" name="{{ form.prefix }}-id" value="{{ form.instance.id }}">
              {% endif %}
            </div>
            <div class="card-body">
              <div class="row d-flex justify-content-center">
                <div class="col-md-4">
                  <div class="form-group">
                    <label for="{{ form.fecha_emision.id_for_label }}" class="font-weight-bold">Fecha Emisión:</label>
                    {{ form.fecha_emision }}
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="form-group">
                    <label for="{{ form.fecha_vencimiento.id_for_label }}" class="font-weight-bold">Fecha Vencimiento:</label>
                    {{ form.fecha_vencimiento }}
                  </div>
                </div>
              </div>
              
              <div class="row">
                <div class="col-md-6">
                  <div class="form-group">
                    <label for="{{ form.centro_medico.id_for_label }}" class="font-weight-bold">Centro Médico:</label>
                    {{ form.centro_medico }}
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-group">
                    <label for="{{ form.medico.id_for_label }}" class="font-weight-bold">Médico:</label>
                    {{ form.medico }}
                  </div>
                </div>
              </div>
              
              <div class="form-group">
                <label for="{{ form.observaciones.id_for_label }}" class="font-weight-bold">Observaciones:</label>
                {{ form.observaciones }}
              </div>
              
            </div>
          </div>
          {% endfor %}
        </div>
        
      </div>
    </div>
    
    <!-- Observaciones Generales -->
    <div class="card mb-4 shadow-sm">
      <div class="card-header bg-light">
        <h4 class="mb-0"><i class="fas fa-clipboard-list mr-2"></i>Observaciones Generales</h4>
      </div>
      <div class="card-body">
        <div class="form-group">
          {{ form.observaciones_generales }}
        </div>
      </div>
    </div>
    
    <!-- Añade esto a tu plantilla para manejar mejor los errores -->
    {% if licencia_formset.non_form_errors %}
    <div class="alert alert-danger">
        {% for error in licencia_formset.non_form_errors %}
            {{ error }}
        {% endfor %}
    </div>
    {% endif %}

    {% for form in licencia_formset %}
        {% if form.non_field_errors %}
        <div class="alert alert-danger">
            {% for error in form.non_field_errors %}
                {{ error }}
            {% endfor %}
        </div>
        {% endif %}
    {% endfor %}

    <!-- Botones de Acción -->
    <div class="row mb-5">
      <div class="col-12 text-right">
        <a href="{% url 'conductores' %}" class="btn btn-lg btn-outline-secondary mr-2">
          <i class="fas fa-times-circle mr-2"></i>Cancelar
        </a>
        <button type="submit" class="btn btn-lg btn-primary">
          <i class="fas fa-save mr-2"></i>Guardar Conductor
        </button>
      </div>
    </div>
  </form>
</div>

<style>
  .card-header {
    border-radius: 0.25rem 0.25rem 0 0 !important;
  }
  .custom-switch .custom-control-label::after {
    background-color: #fff;
  }
  .custom-control-input:checked~.custom-control-label::before {
    border-color: #007bff;
    background-color: #007bff;
  }
  textarea {
    min-height: 100px;
    resize: vertical;
  }
  .form-group {
    margin-bottom: 1.5rem;
  }
</style>

<footer class="footer">
  <section class="text-reserved">
    <h5>2025 © Cuerpo de bomberos - San Cristobal</h>
  </section>
</footer>

<script>
  // Obtener el formulario por su ID
  const form = document.getElementById("");

  if (form) {
    // Seleccionar todas las divs dentro del formulario
    const innerDivs = form.querySelectorAll("div > div");

    // Iterar sobre cada div y aplicar las clases a sus inputs y labels
    innerDivs.forEach(div => {
      const label = div.querySelector("label");
      const input = div.querySelector("input");
      const select = div.querySelector("select");

      if (label) {
        label.classList.add("form-label");
      }

      if (input) {
        input.classList.add("form-control");
      }

      if (select) {
        select.classList.add("form-select");
      }
    });
  }

</script>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Funcionalidad para agregar más licencias
    document.getElementById('add-licencia').addEventListener('click', function() {
        const totalForms = document.getElementById('id_licencias-TOTAL_FORMS');
        const formNum = parseInt(totalForms.value);
        const newForm = document.querySelector('.licencia-form').cloneNode(true);
        
        // Actualizar todos los atributos name/id con el nuevo índice
        const regex = new RegExp('licencias-' + (formNum - 1) + '-', 'g');
        newForm.innerHTML = newForm.innerHTML.replace(regex, 'licencias-' + formNum + '-');
        
        // Limpiar valores
        const inputs = newForm.querySelectorAll('input, select, textarea');
        inputs.forEach(input => {
            if (input.type !== 'hidden' && input.name.indexOf('DELETE') === -1) {
                if (input.type === 'checkbox' || input.type === 'radio') {
                    input.checked = false;
                } else {
                    input.value = '';
                }
            }
        });
        
        // Insertar antes del botón
        document.querySelector('#add-licencia').before(newForm);
        totalForms.value = formNum + 1;
    });
  });
  </script>

{% endblock %}