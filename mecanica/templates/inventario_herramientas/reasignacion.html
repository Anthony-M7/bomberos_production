{% if user.user == "SeRvEr" %}
{% include "layouts/panel_admin.html" %}
{% elif user.user == "Sala_Situacional" %}
{% include "layouts/panel_sala_situacional.html" %}
{% elif user.user == "Comandancia" or user.user == "2dacomandancia" %}
{% include "layouts/panel_comandancia.html" %}
{% elif user.user == "Mecanica_01"%}
{% include "layouts/panel_mecanica.html" %}
{% elif user.user == "Operaciones01"%}
{% include "layouts/panel_operaciones.html" %}
{% elif user.user == "Rescate03"%}
{% include "layouts/panel_rescate.html" %}
{% elif user.user == "Grumae02"%}
{% include "layouts/panel_grumae.html" %}
{% elif user.user == "Prehospitalaria04"%}
{% include "layouts/panel_prehospitalaria.html" %}
{% elif user.user == "Prevencion05"%}
{% include "layouts/panel_prevencion.html" %}
{% endif %}

{% load static %}

{% block content %}
<div class="container-fluid" style="margin-top: 6rem;">
    <div class="row justify-content-center">
        <div class="col-lg-6 col-md-8">
            <div class="card shadow mb-4">
                <div class="card-header bg-danger text-white py-3">
                    <h5 class="my-1">
                        Reasignar Herramienta
                    </h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-danger d-flex flex-wrap justify-content-around">
                        <div class="p-1"><strong>Herramienta:</strong> {{ asignacion.herramienta.nombre }}</div>
                        <div class="p-1"><strong>Unidad origen:</strong> {{ asignacion.unidad.nombre_unidad }}</div>
                        <div class="p-1"><strong>Cantidad disponible:</strong> {{ asignacion.cantidad }} unidades</div>
                        <div class="p-1"><strong>Total disponible en stock:</strong> {{ asignacion.herramienta.cantidad_disponible }} unidades</div>
                    </div>

                    <form method="post">
                        {% csrf_token %}
                        
                        <div class="row mb-4">
                            <div class="col-md-12">
                                <label for="{{ form.cantidad_reasignar.id_for_label }}" class="form-label fw-bold">Cantidad a reasignar *</label>
                                <input type="number" name="cantidad_reasignar" 
                                    class="form-control form-control-lg border-2" 
                                    id="{{ form.cantidad_reasignar.id_for_label }}"
                                    min="1" max="{{ asignacion.cantidad }}"
                                    required>
                                {% if form.cantidad_reasignar.errors %}
                                <div class="alert alert-danger mt-2 py-2">
                                    {{ form.cantidad_reasignar.errors }}
                                </div>
                                {% endif %}
                                <div class="form-text text-muted mt-2">
                                    Máximo disponible en esta unidad: <strong>{{ asignacion.cantidad }}</strong> unidades
                                </div>
                            </div>
                        </div>

                        <div class="row mb-4">
                            <div class="col-md-12">
                                <label for="{{ form.unidad_destino.id_for_label }}" class="form-label fw-bold">Unidad destino *</label>
                                <select name="unidad_destino" 
                                        class="form-select form-select-lg border-2 shadow-sm" 
                                        id="{{ form.unidad_destino.id_for_label }}"
                                        required>
                                    {% for choice in form.unidad_destino.field.choices %}
                                        <option value="{{ choice.0 }}">{{ choice.1 }}</option>
                                    {% endfor %}
                                </select>
                                {% if form.unidad_destino.errors %}
                                <div class="alert alert-danger mt-2 py-2">
                                    <i class="fas fa-exclamation-circle me-2"></i>
                                    {{ form.unidad_destino.errors }}
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="row mb-4">
                            <div class="col-md-12">
                                <label for="{{ form.ordenado_por.id_for_label }}" class="form-label fw-bold">Ordenado Por *</label>
                                <select name="ordenado_por" 
                                        class="form-select form-select-lg border-2 shadow-sm" 
                                        id="{{ form.ordenado_por.id_for_label }}"
                                        required>
                                    {% for choice in form.ordenado_por.field.choices %}
                                        <option value="{{ choice.0 }}">{{ choice.1 }}</option>
                                    {% endfor %}
                                </select>
                                {% if form.ordenado_por.errors %}
                                <div class="alert alert-danger mt-2 py-2">
                                    {{ form.ordenado_por.errors }}
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="row mb-4">
                            <div class="col-md-12">
                                <label for="{{ form.observaciones.id_for_label }}" class="form-label fw-bold"></i>Observaciones</label>
                                <textarea name="observaciones" 
                                        class="form-control border-2 shadow-sm" 
                                        id="{{ form.observaciones.id_for_label }}"
                                        rows="5"
                                        placeholder="Describe el motivo de la reasignación, condición de las herramientas, etc."
                                        style="background-color: #f8f9fa;"></textarea>
                                {% if form.observaciones.errors %}
                                <div class="alert alert-danger mt-2 py-2">
                                    {{ form.observaciones.errors }}
                                </div>
                                {% endif %}
                                <div class="form-text text-muted mt-2">
                                    Describe el motivo de la reasignación
                                </div>
                            </div>
                        </div>

                        <div class="row mt-5">
                            <div class="col-md-6 mb-2">
                                <a href="{% url 'detalle-asignacion' asignacion.unidad.id %}" 
                                class="btn btn-secondary w-100 py-3 fw-bold">
                                    <i class="fas fa-times me-2"></i>Cancelar
                                </a>
                            </div>
                            <div class="col-md-6 mb-2">
                                <button type="submit" class="btn btn-danger w-100 py-3 fw-bold">
                                    <i class="fas fa-exchange-alt me-2"></i>Confirmar Reasignación
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Validación cliente para cantidad máxima
    document.addEventListener('DOMContentLoaded', function() {
        const cantidadInput = document.getElementById('{{ form.cantidad_reasignar.id_for_label }}');
        const maxCantidad = {{ asignacion.cantidad }};
        
        cantidadInput.addEventListener('change', function() {
            const value = parseInt(this.value);
            if (value > maxCantidad) {
                alert('No puedes reasignar más de ' + maxCantidad + ' unidades');
                this.value = maxCantidad;
            }
        });
    });
</script>
{% endblock %}