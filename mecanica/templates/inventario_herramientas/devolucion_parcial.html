{% if user.user == "SeRvEr" %}
{% include "layouts/panel_admin.html" %}
{% elif user.user == "Sala_Situacional" %}
{% include "layouts/panel_sala_situacional.html" %}
{% elif user.user == "Comandancia" or user.user == "2dacomandancia" %}
{% include "layouts/panel_comandancia.html" %}
{% elif user.user == "Mecanica_01"%}
{% include "layouts/panel_mecanica.html" %}
{% elif user.user == "Operaciones01"%}
{% include "layouts/panel_operaciones.html" %}
{% elif user.user == "Rescate03"%}
{% include "layouts/panel_rescate.html" %}
{% elif user.user == "Grumae02"%}
{% include "layouts/panel_grumae.html" %}
{% elif user.user == "Prehospitalaria04"%}
{% include "layouts/panel_prehospitalaria.html" %}
{% elif user.user == "Prevencion05"%}
{% include "layouts/panel_prevencion.html" %}
{% endif %}

{% load static %}

{% block content %}
<div class="container-fluid" style="margin-top: 6rem;">
    <div class="row justify-content-center">
        <div class="col-lg-6 col-md-8">
            <div class="card shadow mb-4">
                <div class="card-header bg-danger text-white">
                    <h5 class="my-1">
                        Devolución Parcial de Herramienta
                    </h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-danger d-flex flex-wrap justify-content-around">
                        <div class="p-1"><strong>Herramienta:</strong> {{ asignacion.herramienta.nombre }}</div>
                        <div><strong>Unidad:</strong> {{ asignacion.unidad.nombre_unidad }}</div>
                        <div><strong>Cantidad asignada:</strong> {{ asignacion.cantidad }} unidades</div>
                    </div>

                    <form method="post">
                        {% csrf_token %}
                        
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <label for="{{ form.cantidad_devolver.id_for_label }}" class="form-label">
                                    <strong>Cantidad a devolver *</strong>
                                </label>
                                <input type="number" name="cantidad_devolver" 
                                    class="form-control form-control-lg" 
                                    id="{{ form.cantidad_devolver.id_for_label }}"
                                    min="1" max="{{ asignacion.cantidad }}"
                                    required>
                                {% if form.cantidad_devolver.errors %}
                                <div class="text-danger small mt-1">
                                    {{ form.cantidad_devolver.errors }}
                                </div>
                                {% endif %}
                                <div class="form-text">
                                    Máximo disponible: {{ asignacion.cantidad }} unidades
                                </div>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-12">
                                <label for="{{ form.ordenado_por.id_for_label }}" class="form-label">
                                    <strong>Ordenado por *</strong>
                                </label>
                                <select name="ordenado_por" 
                                        class="form-select form-select-lg border-2 shadow-sm" 
                                        id="{{ form.ordenado_por.id_for_label }}">
                                    {% for choice in form.ordenado_por.field.choices %}
                                        <option value="{{ choice.0 }}">{{ choice.1 }}</option>
                                    {% endfor %}
                                </select>
                                {% if form.recibido_por.errors %}
                                <div class="text-danger small mt-1">
                                    {{ form.recibido_por.errors }}
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-12">
                                <label for="{{ form.observaciones.id_for_label }}" class="form-label">
                                    <strong>Observaciones</strong>
                                </label>
                                <textarea name="observaciones" 
                                        class="form-control" 
                                        id="{{ form.observaciones.id_for_label }}"
                                        rows="4"
                                        placeholder="Ingrese observaciones de la devolución"></textarea>
                                {% if form.observaciones.errors %}
                                <div class="text-danger small mt-1">
                                    {{ form.observaciones.errors }}
                                </div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="row mt-4">
                            <div class="col-md-6">
                                <a href="{% url 'detalle-asignacion' asignacion.unidad.id %}" class="btn btn-secondary w-100 py-2 my-1">Cancelar</a>
                            </div>
                            <div class="col-md-6">
                                <button type="submit" class="btn btn-danger w-100 py-2 my-1">Confirmar Devolución</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Validación cliente para cantidad máxima
    document.addEventListener('DOMContentLoaded', function() {
        const cantidadInput = document.getElementById('{{ form.cantidad_devolver.id_for_label }}');
        const maxCantidad = {{ asignacion.cantidad }};
        
        cantidadInput.addEventListener('change', function() {
            const value = parseInt(this.value);
            if (value > maxCantidad) {
                alert('No puedes devolver más de ' + maxCantidad + ' unidades');
                this.value = maxCantidad;
            }
        });
    });
</script>
{% endblock %}